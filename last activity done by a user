drop table if exists user_activity ;
create temp table user_activity as
select   new_users.joined_date as date ,
      (TIMESTAMP 'epoch' + r.at * INTERVAL '1 second') as time_stamp,
       r.direct_object.name as page_viewed,r.verb as verb,
       new_users.user_id as user_id,
       rank() over (partition by user_id order by time_stamp ) as rank_users
from new_users
inner join external_spark_tables.raw_events r on new_users.user_id =  r.actor.id and new_users.joined_date = r.event_date
where
r.verb in('view','click')
and r.using.app_type in ('iphone','ipad')
and r.using.domain in ('us')
and r.actor.id is not null
and r.direct_object.name is not null
and r.actor.type in ('user')
and new_users.joined_date = '2024-04-02'
group by 1,2,3,4,5
order by 2 ,5  ;

select * from user_activity limit 30;
--Last activity done by the user on the D1
drop table if exists last ;
create temp table last as
select distinct user_id,max(rank_users ) as r
from user_activity
group by 1 ;
with x as (
select user_activity.user_id,user_activity.page_viewed,last.r
from user_activity
join last on user_activity.user_id = last.user_id and user_activity.rank_users = last.r )
select distinct user_id,page_viewed  from x
group by 1,2
order by 2 desc;
